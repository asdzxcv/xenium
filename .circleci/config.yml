version: 2.1

jobs:
  build-linux:
    parameters:
      resource-class:
        type: string
      build-config:
        type: string
      compiler:
        type: string
    machine:
      image: ubuntu-2404:current
    resource_class: << parameters.resource-class >>

    steps:
      - run:
          name: "Install dependencies"
          environment:
            DEBIAN_FRONTEND: noninteractive
            TZ: Etc/UTC
          command: "sudo apt-get update && sudo apt-get install -y git cmake g++-14 clang++-18"
      - checkout
      - run:
          name: "Prepare build"
          command: |
            git submodule update --init --recursive
            mkdir build
            cd build
            # TODO - enable TSAN
            cmake .. -DCMAKE_CXX_COMPILER=<< parameters.compiler >> -DCMAKE_CXX_STANDARD=17 -DCMAKE_BUILD_TYPE=<< parameters.build-config >> -DWITH_TSAN=On
      - run:
          name: "Build"
          command: "make -j 4"
          working_directory: build
      - run:
          name: "Run tests"
          command: |
            sudo sysctl vm.mmap_rnd_bits
            sudo sysctl vm.mmap_rnd_bits=30
            ./gtest --gtest_output=xml:gtest.xml
          working_directory: build
      - store_test_results:
            path: build/gtest.xml
      # - persist_to_workspace:
      #     root: build
      #     paths: benchmark

workflows:
  Linux-x64:
    jobs:
      - build-linux:  
          matrix:
            parameters:
              compiler: ["clang++-18", g++-14]
              build-config: ["Debug", "Release"]
              resource-class: ["large"]
              
  # Linux-ARM:
  #   jobs:
  #     - build-linux:  
  #         matrix:
  #           parameters:
  #             compiler: ["clang++-15", g++]
  #             build-config: ["Debug", "Release"]
  #             resource-class: ["arm.large"]
